---
title: "Introduction to ggswim"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The ggswim package provides users with a convenient and flexible framework for quickly developing swimmer plots in a way that coincides with typical ggplot2 design principles. In this article, we will demonstrate some of the options available to developers.

In its current state, ggswim uses two main functions: `ggswim()` and `add_marker()`. 

`ggswim()` is wrapped around `geom_col()` and is responsible for providing the horizontal bars of a swimmer plot, what we'll refer to as the "lanes." `add_marker()` is wrapped around `geom_point()` and `geom_label()` to add points/shapes/labels or what we'll refer to as the "markers" for events on the swimmer plots lanes.

Because ggswim is built on top of existing ggplot2 infrastructure, those familiar with ggplot2 will be able to implement the same layer-building development practices they are used to, including stylizing and themes.

### Building swimmer plots with aesthetic mapping

In this first example, let's build a swimmer plot using `aes()` and dynamic mapping of data. As with the README, we will be using ggswim's internal `patient_data` list dataset. 

As mentioned in the README, `patient_status` is currently built to reflect a typical dataset in the wild. To make this work well and appear nicely in our swimmer plot output, a little bit of some preparation was required. Unlike what we provide for you out of the box, a more typical `patient_status` might look something like this:

```{r load dplyr, include=FALSE}
library(dplyr)
```

```{r prep patient_status, echo=FALSE, include=TRUE}
set.seed(123)

tibble::tibble(subject_id = rep(1:10, length.out = 15)) |>
  sample_n(15) |>
  arrange(subject_id) |>
  mutate(
    .by = subject_id,
    cohort = rep(sample(c("Cohort A", "Cohort B"), 1), length.out = n(), each = length(unique(subject_id))),
    cohort = factor(cohort, levels = c("Cohort B", "Cohort A")),
    status = ifelse(duplicated(subject_id) | !duplicated(subject_id, fromLast = TRUE), "On Study", "Off Study"),
    status = factor(status, levels = c("On Study", "Off Study"), ordered = TRUE),
    time_end = ifelse(status == "On Study", runif(n(), 1, 10), runif(n(), 11, 20)),
    time_start = ifelse(status == "On Study", 0, NA),
    time_start = ifelse(is.na(time_start), lead(time_end), time_start)
  ) |>
  arrange(subject_id, status) |>
  relocate(time_start, .before = time_end) |>
  mutate(subject_id = factor(subject_id))
```

Therefore, when viewing the available `patient_status`, keep in mind it has undergone the following data cleaning steps:

- A pivot so that `time_start` and `time_end` comprise a single value.
- Addition of a sorting variable, `time_sorting`, to support arrangement using summed time values
- Arrangement of the data by cohort groups, time sorted values, and subject ID factor levels

```{r}
library(ggswim)

patient_status
```

Now, let's make the plot using `ggswim()` and our first `add_marker()` call:

```{r aes mapping plot}
p <- ggswim(data = patient_status,
            mapping = aes(x = value,
                          y = subject_id,
                          fill = cohort)) +
  add_marker(data = adverse_events,
             mapping = aes(x = time_of_event,
                           y = subject_id,
                           color = adverse_event_name,
                           shape = adverse_event_name),
             size = 5)

p
```

This is great for shapes and points, but what if we wanted to get fancy and add in some labels like emojis? This is where some ggswim magic really shines. ggswim's `add_marker()` allows for both types of displays to appear and does the leg work of rending them both appropriately in the legend under the same layer. Let's add these with another `add_marker()` call using the `medication_administration` data:

```{r label mapping}
p <- p +
  add_marker(data = medication_administration,
             mapping = aes(x = time_of_event,
                           y = subject_id,
                           label = medication,
                           color = name),
             label.size = NA, fill = NA, size = 5)

p
```

This is great and all, but it could look better right? Remember how earlier we mentioned you can use existing ggplot2 functions with ggswim outputs? Let's implement some here so we can find a bit more joy in our plot:

```{r mapping finalizing, message=FALSE}
library(ggplot2)

p +
  labs(x = "Time", y = "Subject ID", color = "Markers") +
  ggtitle("My Swim Plot") +
  theme_minimal() +
  scale_color_manual(
    name = "Markers",
    values = c("firebrick", "tomato", NA, NA, "chartreuse2")
  ) +
  scale_shape_manual(
    name = "Markers",
    values = c(19, 15, 8, 18)
  ) +
  scale_fill_manual(
    name = "Lanes",
    values = c("steelblue", "cyan")
  )
```

### Building swimmer plots with individual markers

Not all data is made, or received equal, and so ggswim was developed to cater to both dynamic mapping of markers as well as static assignment of markers. What do we mean by this?

Well, let's say that instead of setting your mapped `aes()` "colour" to a variable, you instead only have one marker in the dataset supplied and want to define the `color` yourself. Let's split up `adverse_events` so there is only one marker level per dataframe. 

For this to work, we also need to specify an `aes()` `name` argument to `add_marker()` which acts as an anchor point for the legend.

```{r static mapping}
adverse_event_cardio <- adverse_events |>
  dplyr::filter(adverse_event_name == "Cardiac Disorder")

adverse_event_inf <- adverse_events |>
  dplyr::filter(adverse_event_name == "Infection")

adverse_event_psych <- adverse_events |>
  dplyr::filter(adverse_event_name == "Psychiatric Disorder")
```

Now, let's plot it similarly to what we did above:

```{r static plot}
ggswim(data = patient_status,
       mapping = aes(x = value,
                     y = subject_id,
                     fill = cohort)) +
  add_marker(data = adverse_event_cardio,
             mapping = aes(x = time_of_event,
                           y = subject_id,
                           name = "AE: Cardiac Disorder"),
             color = "red", size = 5) +
  add_marker(data = adverse_event_inf,
             mapping = aes(x = time_of_event,
                           y = subject_id,
                           name = "AE: Infection"),
             color = "blue", size = 5, shape = 12) +
  add_marker(data = adverse_event_psych,
             mapping = aes(x = time_of_event,
                           y = subject_id,
                           name = "AE: Psychiatric Disorder"),
             color = "green", size = 5, shape = 2)
```

This example showcases ggswim's ability to handle different data structures from varying sources. Due to its flexible framework, users can customize the output to suit whatever best suits their needs.

### Additional notes

- ggswim does not support missing data for mapping aesthetics. Developers will be warned about missing data that may appear in the display, but will be removed from the legend.
- `ggswim()` does not support mapping using the `colour` argument
- `add_marker()` does not support mapping using the `fill` argument
- For emojis and other shapes to properly appear, users may need to switch the graphics rendering device to AGG
