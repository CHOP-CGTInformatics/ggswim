---
title: "Getting Started with ggswim"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The ggswim package eases the development of swimmer plots in R by seamlessly integrating with the ggplot2 framework. In this vignette, we'll walk through how users can create visually striking swimmer plots.

At the heart of ggswim are two pivotal functions: `ggswim()` and `add_marker()`. The former, an extension of `geom_col()`, allows users to construct the fundamental horizontal bars, often referred to as "lanes." Meanwhile, `add_marker()` leverages `geom_point()` and `geom_label()` to effortlessly embed key events or "markers" onto the plot. These can take the form of unicode shapes, symbols, or even emojis.

Drawing from the well-established principles of ggplot2, ggswim allows users to apply familiar layer-building techniques, including the application of styles and themes.

Let's dive in and explore the boundless possibilities that `ggswim` offers for expressive swimmer plots!

### Building swimmer plots with aesthetic mapping

To start, let's build a swimmer plot using `aes()` and dynamic mapping of data. As with the README, we will be using ggswim's internal dataseta: `patient_data`, `infusion_events`, and `end_study_events`. 

Let's start with observing the structure of each dataset:

```{r patient_data , echo=FALSE, include=TRUE}
library(ggswim)

patient_data |> 
  rmarkdown::paged_table()
```

`patient_data` contains a long dataset where patient ID's (`pt_id`) can be repeated. These rows are differentiated by `event_marker`s and corresponding times. Together, these rows signify a patient trajectory with consideration for infusions and disease assessment time points. You'll notice several other columns that give more information:

- `bcell_status`: The B-Cell status of a given patient at a particular time point, indicating aplasia or recovery
- `disease_assessment_status`: The overall status at a disease assessment timepoint where:
- CR = "Complete Response"
- CRi = "Complete Response with Incomplete Blood Count Recovery"
- RD = "Relapsed Disease"

Now, let's make the plot using `ggswim()` and our first `add_marker()` call:

```{r ggswim plot}
p <- ggswim(
  patient_data |> dplyr::rename("Status Markers" = bcell_status),
  mapping = aes(x = delta_t0_months,
                y = pt_id, fill = 
                  disease_assessment_status)
)

p
```

Here we have a simple bar chart, showing infusions grouped by patients with a given disease assessment status. `ggswim()` does the work of setting up a `geom_col()` and readying your plot layers for additional ggwim-specific features such as "markers." Let's add a marker layer next and reference `bcell_status` from the same `patient_data` dataset. Additionally, we'll add another marker layer from the `infusion_events` dataset:

```{r infusion_events}
infusion_events |> 
  rmarkdown::paged_table()
```

This dataset is much simpler, having only 3 columns indicating infusions (considered `t0`) and reinfusions at some point beyond `t0` if a patient required any.

```{r first marker plot}

p <- p +
  add_marker(
    aes(x = delta_t0_months, 
        y = pt_id, 
        color = `Status Markers`, 
        shape = `Status Markers`),
    size = 5, position = "identity", alpha = 1
  ) +
  add_marker(
    data = infusion_events,
    aes(x = infusion_delta_t0, 
        y = pt_id, 
        color = infusion_type, 
        shape = infusion_type),
    size = 5, position = "identity", alpha = 1
  )

p
```

Now we can see shapes have been added to establish our markers... though some blend into the colors of the bar charts. We'll fix this soon enough! For now, we can see that a new legend has been added to articulate the markers we added for the b-cell disease assessment and infusion events.

Our last dataset involved end of study events, i.e. events that indicate a patient has left the study for varying reasons.

```{r end_study_events}
end_study_events |> 
  rmarkdown::paged_table()
```

You'll notice that this dataset includes use of emojis under `end_study_label`. In addition to shapes and symbols, ggswim supports the use of emojis when rendering swimmer plots. `add_marker()` allows users to specify shapes or emojis by using the appropriate argument callouts (`label` and `shape`). Let's add a layer using emojis via the `end_study_events` dataset:

```{r second marker plot}
p <- p +
  add_marker(
    data = end_study_events,
    aes(x = delta_t0_months, 
        y = pt_id, 
        label = end_study_label, 
        color = end_study_name),
    label.size = NA, fill = NA, size = 5
  )

p
```

At this point we have a working swimmer plot with lanes and two different kinds of marker layers. Recall that ggswim works within the ggplot2 framework, therefore customization can be done using the same ggplot2 theme and styling functions users may already be familiar with. Let's fix up this plot so it looks nicer on the eyes:

```{r mapping finalizing, message=FALSE, warning=FALSE}
library(ggplot2)

p <- p +
  theme_minimal() +
  scale_colour_manual(
    values = c("firebrick", "#F5EB0A", "gray50", NA, NA, NA, "#25DA6D", "#25DA6D")
  ) +
  scale_shape_manual(
    values = c(19, 19, 15, 17, 18)
  ) +
  scale_fill_manual(
    name = "Overall Disease Assessment",
    values = c("#6394F3", "#F3C363", "#EB792F")
  ) +
  labs(title = "Prodigy Swimmer Plot") +
  xlab("Time (Months)") + ylab("Patient ID")

p
```

We also supply the `theme_ggswim()` function:

```{r mapping with theme_ggswim}
p +
  theme_ggswim()
```

### Customizing Markers: A Deeper Dive

In the world of data, one size rarely fits all. That's why ggswim caters to both dynamic and static marker assignments. But what does that mean exactly?

Imagine you have a dataset where you want to manually define the color of a single, significant marker rather than relying on a mapped variable. By splitting up `infusion_events` into distinct data frames, you can achieve this customized effect.

To make it all come together, make sure to include an `aes()` `name` argument within `add_marker()`. This serves as a crucial anchor point for the legend, ensuring clarity in your visualization.


```{r static mapping}
initial_infusions <- infusion_events |>
  dplyr::filter(infusion_type == "Infusion")

reinfusions <- infusion_events |>
  dplyr::filter(infusion_type == "Reinfusion")
```

Now, let's plot it similarly to how we have previously:

```{r static plot, message=FALSE, warning=FALSE}
ggswim(
  data = patient_data |> dplyr::rename("Status Markers" = bcell_status),
  mapping = aes(x = delta_t0_months, y = pt_id, fill = disease_assessment_status)
) +
  # Same markers as before for Disease Assessment
  add_marker(
    aes(x = delta_t0_months, 
        y = pt_id, 
        color = `Status Markers`, 
        shape = `Status Markers`),
    size = 5, position = "identity", alpha = 1
  ) +
  # New manual color markers for Infusions
  add_marker(
    data = initial_infusions,
    aes(x = infusion_delta_t0, y = pt_id, name = "Initial Infusion"),
    size = 5, position = "identity", color = "green"
  ) +
  add_marker(
    data = reinfusions,
    aes(x = infusion_delta_t0, y = pt_id, name = "Reinfusion"),
    size = 5, position = "identity", color = "red"
  ) +
  theme_ggswim()
```

This example showcases ggswim's ability to handle different data structures from varying sources. Its adaptable framework lets users customize the output precisely to their unique requirements.

### Additional notes

Here are some essential points to keep in mind when working with ggswim:

- **Handling Missing Data:** ggswim does not support missing data for mapping aesthetics. If any are detected, developers will receive a warning, and the missing data may appear as `NA` values in the display, but will be excluded from the legend.

- **Color Mapping with `ggswim()`:** Please note that `ggswim()` does not support mapping using the `colour` argument.

- **Filling Markers with `add_marker()`:** Similarly, `add_marker()` does not support mapping using the `fill` argument.

- **Rendering Emojis and Custom Shapes:** To ensure emojis and other custom shapes display correctly, users may need to switch the graphics rendering device to AGG.

These considerations will help you make the most of ggswim while building your visualizations.
